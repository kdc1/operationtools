<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로컬 차트 관리자</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#2a3545; --text:#e8eef9; --sub:#a8b3c7; --accent:#6aa6ff; --danger:#ff6b6b; --warn:#f9b24d; --ok:#55e6a5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif}
    a{color:var(--accent);text-decoration:none}
    button,input,select,textarea{font:inherit;color:inherit}
    .app{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:16px}
    .title{font-size:20px;font-weight:700}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:var(--panel);border:1px solid var(--muted);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#1a2331,#121821);border-color:#3a4b66}
    .section{background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:16px;margin-bottom:14px}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns: 1fr 1fr}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--sub)}
    .input, .select, .textarea{background:#0e141d;border:1px solid var(--muted);padding:8px 10px;border-radius:10px;outline:none}
    .textarea{min-height:72px;resize:vertical}
    .btn{background:#182233;border:1px solid #334762;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#1b2d4d;border-color:#345a99}
    .btn.ghost{background:transparent;border-color:var(--muted)}
    .btn.warn{background:#3a2a10;border-color:#6a4b1a}
    .btn.danger{background:#3a1414;border-color:#6a2a2a}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--muted);background:#0e141d;font-size:12px;color:var(--sub)}
    .badge.ok{border-color:#256f57;color:#98ffdc}
    .badge.warn{border-color:#7c5a16;color:#ffd79a}
    .badge.danger{border-color:#7c1818;color:#ffb0b0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--muted);padding:8px 6px;text-align:left}
    .table tr:hover{background:#0f1620}
    .helper{font-size:12px;color:var(--sub)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .list{display:flex;flex-direction:column;gap:6px;min-height:200px}
    .item{display:grid;grid-template-columns:40px 1fr auto;gap:10px;align-items:center;background:#0e141d;border:1px solid var(--muted);border-radius:12px;padding:8px}
    .item[data-banned="true"]{opacity:.5}
    .item .drag{cursor:grab;user-select:none;color:var(--sub);text-align:center}
    .item .meta{display:flex;flex-direction:column}
    .item .actions{display:flex;gap:6px}
    .pill{border:1px solid var(--muted);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--sub)}
    .muted{color:var(--sub)}
    .shadow{box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .sticky{position:sticky;top:10px}
    .rank{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#121a26;border:1px solid var(--muted);font-weight:700}
    .hr{height:1px;background:var(--muted);margin:10px 0}
    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,monospace;background:#0e141d;border:1px solid var(--muted);border-bottom-width:3px;padding:2px 6px;border-radius:6px}
    @media (max-width: 980px){
      .grid.cols-2{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
      .sticky{position:static}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="row" style="align-items:center">
        <div class="title">🎛️ 로컬 차트 관리자</div>
        <div class="badge">로컬스토리지 기반</div>
      </div>
      <div class="tabs" role="tablist">
        <button class="tab" data-tab="songs" aria-selected="true">곡 데이터</button>
        <button class="tab" data-tab="weeks">주차 차트</button>
        <button class="tab" data-tab="backup">백업/복원</button>
      </div>
    </div>

    <!-- 곡 데이터 탭 -->
    <section id="tab-songs" class="section" role="tabpanel">
      <div class="grid cols-2">
        <div class="section shadow">
          <h3 style="margin:0 0 8px">곡 등록/수정</h3>
          <div class="grid">
            <div class="field">
              <label>🐞 트랙ID (필수)</label>
              <input id="song-id" class="input" placeholder="예: 12345678" />
            </div>
            <div class="row">
              <div class="field grow">
                <label>곡명</label>
                <input id="song-title" class="input" />
              </div>
              <div class="field grow">
                <label>아티스트명</label>
                <input id="song-artist" class="input" />
              </div>
            </div>
            <div class="row">
              <div class="field grow">
                <label>발매일</label>
                <input id="song-release" type="date" class="input" />
              </div>
              <div class="field grow">
                <label>1위 지정일</label>
                <input id="song-first1" type="date" class="input" />
              </div>
            </div>
            <div class="row">
              <label class="badge warn"><input id="song-blocked" type="checkbox" /> 차단여부</label>
              <label class="badge danger"><input id="song-banned" type="checkbox" /> 사용금지여부</label>
            </div>
            <div class="field">
              <label>곡 히스토리(메모)</label>
              <textarea id="song-history" class="textarea" placeholder="자유 서술"></textarea>
            </div>
            <div class="row">
              <button id="song-save" class="btn primary">저장/업데이트</button>
              <button id="song-clear" class="btn ghost">입력 초기화</button>
              <span class="helper">행을 클릭하면 편집됩니다.</span>
            </div>
          </div>
        </div>
        <div class="section shadow">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">곡 목록</h3>
            <input id="song-search" class="input" placeholder="검색: 제목/아티스트/ID" style="max-width:280px" />
          </div>
          <div class="hr"></div>
          <div style="max-height:420px;overflow:auto">
            <table class="table" id="song-table">
              <thead>
                <tr>
                  <th>ID</th><th>곡명</th><th>아티스트</th><th>발매일</th><th>상태</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 주차 차트 탭 -->
    <section id="tab-weeks" class="section" role="tabpanel" hidden>
      <div class="grid">
        <div class="section shadow">
          <div class="row" style="align-items:flex-end; gap:12px; flex-wrap:wrap">
            <div class="field">
              <label>현재 주차 시작일</label>
              <input type="date" id="current-week-date" class="input" />
            </div>
            <button class="btn" id="btn-load-current">불러오기/생성</button>
            <div class="field">
              <label>이전 주차 선택</label>
              <select id="prev-week-select" class="select"></select>
            </div>
            <button class="btn ghost" id="btn-copy-prev">이전 주차 복사 → 현재</button>
            <div class="grow"></div>
            <div class="row">
              <input id="add-trackid" class="input" placeholder="트랙ID 추가" style="width:140px" />
              <button class="btn" id="btn-add-track">추가</button>
              <button class="btn warn" id="btn-save-week">현재 주차 저장</button>
            </div>
          </div>
        </div>

        <div class="split">
          <div class="section shadow sticky">
            <h3 style="margin:0 0 8px">이전 주차 (읽기 전용)</h3>
            <div id="prev-list" class="list" aria-label="이전 주차 차트"></div>
          </div>
          <div class="section shadow">
            <h3 style="margin:0 0 8px">현재 주차 (드래그로 순위 편집)</h3>
            <div id="current-list" class="list" aria-label="현재 주차 차트"></div>
            <div class="hr"></div>
            <div class="helper">드래그하여 순서를 바꾸면 자동으로 순위가 업데이트됩니다. 각 항목의 ✎을 눌러 주차 히스토리를 기록하세요.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 백업/복원 탭 -->
    <section id="tab-backup" class="section" role="tabpanel" hidden>
      <div class="grid">
        <div class="section shadow">
          <h3 style="margin:0 0 8px">JSON 내보내기</h3>
          <div class="row">
            <button class="btn primary" id="btn-export">백업 파일 다운로드</button>
            <span class="helper">현재 로컬스토리지의 모든 데이터(songs, weeks)를 JSON으로 저장합니다.</span>
          </div>
        </div>
        <div class="section shadow">
          <h3 style="margin:0 0 8px">JSON 가져오기</h3>
          <div class="row" style="align-items:center; gap:12px">
            <input type="file" id="import-file" accept="application/json" />
            <label class="badge warn"><input type="checkbox" id="import-merge" checked /> 병합(중복은 덮어쓰기)</label>
            <button class="btn danger" id="btn-import">가져오기</button>
          </div>
          <p class="helper">병합을 해제하면 기존 데이터를 모두 지우고 파일로 교체합니다. 이 작업은 되돌릴 수 없습니다.</p>
          <div class="hr"></div>
          <button class="btn ghost" id="btn-wipe">⚠️ 전체 초기화</button>
        </div>
      </div>
    </section>
  </div>

  <template id="tmpl-item">
    <div class="item" draggable="true">
      <div class="drag rank">#</div>
      <div class="meta"></div>
      <div class="actions"></div>
    </div>
  </template>

  <script>
    // ============================
    // 저장소 (localStorage)
    // ============================
    const STORAGE_KEY = 'chartManagerData.v1';
    const emptyState = { songs: {}, weeks: {} };

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(emptyState);
        const parsed = JSON.parse(raw);
        return { songs: parsed.songs||{}, weeks: parsed.weeks||{} };
      }catch(e){
        console.error('load error',e);return structuredClone(emptyState);
      }
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // ============================
    // 유틸
    // ============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function fmtDate(d){
      if(!d) return '';
      try{ return new Date(d).toISOString().slice(0,10);}catch{ return d; }
    }

    function ensureWeek(dateStr){
      if(!state.weeks[dateStr]) state.weeks[dateStr] = { weekStart: dateStr, entries: [] };
      return state.weeks[dateStr];
    }

    function rankify(entries){
      return entries.map((e,i)=> ({...e, rank:i+1}));
    }

    function createSongRow(song){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${song.id}</td>
        <td>${escapeHtml(song.title||'')}</td>
        <td>${escapeHtml(song.artist||'')}</td>
        <td>${fmtDate(song.releaseDate)||''}</td>
        <td>${song.banned?'<span class="pill">🚫 금지</span>': song.blocked?'<span class="pill">⛔ 차단</span>':'<span class="pill">정상</span>'}</td>`;
      tr.addEventListener('click',()=>fillSongForm(song));
      return tr;
    }

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    function buildPrevWeekOptions(){
      const sel = $('#prev-week-select');
      sel.innerHTML = '';
      const dates = Object.keys(state.weeks).sort();
      for(const d of dates){
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d; sel.appendChild(opt);
      }
    }

    // ============================
    // 탭 전환
    // ============================
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.tab').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const tab = btn.dataset.tab;
        $('#tab-songs').hidden = tab!=='songs';
        $('#tab-weeks').hidden = tab!=='weeks';
        $('#tab-backup').hidden = tab!=='backup';
        if(tab==='weeks') buildPrevWeekOptions();
        if(tab==='songs') renderSongTable();
      })
    })

    // ============================
    // 곡 CRUD
    // ============================
    function fillSongForm(song){
      $('#song-id').value = song.id || '';
      $('#song-title').value = song.title || '';
      $('#song-artist').value = song.artist || '';
      $('#song-release').value = fmtDate(song.releaseDate) || '';
      $('#song-first1').value = fmtDate(song.firstNo1Date) || '';
      $('#song-blocked').checked = !!song.blocked;
      $('#song-banned').checked = !!song.banned;
      $('#song-history').value = song.history || '';
      $('#song-id').focus();
    }

    function readSongForm(){
      const id = $('#song-id').value.trim();
      if(!id){ alert('트랙ID는 필수입니다.'); return null; }
      return {
        id,
        title: $('#song-title').value.trim(),
        artist: $('#song-artist').value.trim(),
        releaseDate: $('#song-release').value || null,
        firstNo1Date: $('#song-first1').value || null,
        blocked: $('#song-blocked').checked,
        banned: $('#song-banned').checked,
        history: $('#song-history').value.trim()
      };
    }

    function clearSongForm(){
      ['song-id','song-title','song-artist','song-release','song-first1','song-history'].forEach(id=>$('#'+id).value='');
      $('#song-blocked').checked=false; $('#song-banned').checked=false;
    }

    function renderSongTable(){
      const q = ($('#song-search').value||'').toLowerCase();
      const tbody = $('#song-table tbody');
      tbody.innerHTML = '';
      const rows = Object.values(state.songs)
        .sort((a,b)=> (a.artist||'').localeCompare(b.artist||'') || (a.title||'').localeCompare(b.title||''))
        .filter(s=> !q || [s.id, s.title, s.artist].join(' ').toLowerCase().includes(q));
      rows.forEach(s=> tbody.appendChild(createSongRow(s)));
    }

    $('#song-save').addEventListener('click',()=>{
      const s = readSongForm(); if(!s) return;
      state.songs[s.id] = s; saveState(); renderSongTable();
      // 이미 주차에 있는 항목에 상태 반영을 위해 현재 주차 재렌더
      renderCurrentWeek();
    });
    $('#song-clear').addEventListener('click', clearSongForm);
    $('#song-search').addEventListener('input', renderSongTable);

    renderSongTable();

    // ============================
    // 주차 차트
    // ============================
    let currentWeek = null; // {weekStart, entries}

    function loadPrevWeekIntoList(dateStr){
      const container = $('#prev-list');
      container.innerHTML = '';
      const wk = state.weeks[dateStr];
      if(!wk){ container.innerHTML = '<div class="muted">선택된 이전 주차가 없습니다.</div>'; return; }
      wk.entries.sort((a,b)=>a.rank-b.rank);
      wk.entries.forEach((e,i)=>{
        const song = state.songs[e.trackId] || { id:e.trackId, title:'(미등록)', artist:'' };
        const el = renderListItem({ entry:e, song, readonly:true });
        container.appendChild(el);
      });
    }

    function renderListItem({entry, song, readonly}){
      const tpl = document.getElementById('tmpl-item');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.dataset.trackId = entry.trackId;
      node.dataset.banned = song.banned ? 'true' : 'false';
      node.querySelector('.rank').textContent = entry.rank ? '#' + entry.rank : '#';
      node.querySelector('.meta').innerHTML = `
        <div><strong>${escapeHtml(song.title||'(제목없음)')}</strong> — ${escapeHtml(song.artist||'')}</div>
        <div class="muted">ID: ${song.id} · 발매일 ${fmtDate(song.releaseDate)||'-'} ${song.blocked?'<span class="badge warn">차단</span>':''} ${song.banned?'<span class="badge danger">금지</span>':''}</div>
        ${entry.note?`<div class="helper">주차 메모: ${escapeHtml(entry.note)}</div>`:''}
      `;
      const actions = node.querySelector('.actions');
      if(!readonly){
        const btnNote = document.createElement('button'); btnNote.className='btn ghost'; btnNote.textContent='✎ 메모';
        btnNote.addEventListener('click',()=>{
          const val = prompt('이 항목의 주차 히스토리/메모', entry.note||'');
          if(val!==null){ entry.note = val; saveState(); renderCurrentWeek(); }
        });
        const btnRemove = document.createElement('button'); btnRemove.className='btn danger'; btnRemove.textContent='삭제';
        btnRemove.addEventListener('click',()=>{
          currentWeek.entries = currentWeek.entries.filter(x=>x.trackId!==entry.trackId);
          currentWeek.entries = rankify(currentWeek.entries);
          saveState(); renderCurrentWeek();
        });
        actions.append(btnNote, btnRemove);
      } else {
        const pill = document.createElement('span'); pill.className='pill'; pill.textContent = '순위 '+entry.rank; actions.appendChild(pill);
      }

      if(!readonly){
        node.addEventListener('dragstart', (ev)=>{
          ev.dataTransfer.setData('text/plain', entry.trackId);
          node.classList.add('dragging');
        });
        node.addEventListener('dragend', ()=> node.classList.remove('dragging'));
      } else {
        node.draggable = false;
      }

      return node;
    }

    function renderCurrentWeek(){
      const container = $('#current-list');
      container.innerHTML = '';
      if(!currentWeek){ container.innerHTML='<div class="muted">오른쪽 상단에서 주차를 불러오세요.</div>'; return; }
      currentWeek.entries.sort((a,b)=>a.rank-b.rank);
      currentWeek.entries.forEach(e=>{
        const song = state.songs[e.trackId] || { id:e.trackId, title:'(미등록)', artist:'' };
        const el = renderListItem({ entry:e, song, readonly:false });
        container.appendChild(el);
      });
      updateDragHandlers();
    }

    function updateDragHandlers(){
      const list = $('#current-list');
      list.addEventListener('dragover', (ev)=>{
        ev.preventDefault();
        const dragging = $('.item.dragging');
        const after = getDragAfterElement(list, ev.clientY);
        if(!dragging) return;
        if(after==null){ list.appendChild(dragging); }
        else { list.insertBefore(dragging, after); }
      });
      list.addEventListener('drop', ()=>{
        // 읽어 새 순위 반영
        const ids = $$('.item', list).map(n=>n.dataset.trackId);
        currentWeek.entries = ids.map((id,i)=>{
          const found = currentWeek.entries.find(e=>e.trackId===id) || {trackId:id};
          return { ...found, rank: i+1 };
        });
        saveState(); renderCurrentWeek();
      });
    }

    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.item:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){
          return {offset, element: child};
        } else { return closest; }
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    function addTrackToCurrent(trackId){
      if(!currentWeek){ alert('먼저 현재 주차를 불러오세요.'); return; }
      if(currentWeek.entries.some(e=>e.trackId===trackId)) return;
      const nextRank = currentWeek.entries.length + 1;
      currentWeek.entries.push({trackId, rank: nextRank, note:''});
      saveState(); renderCurrentWeek();
    }

    // Controls
    $('#btn-load-current').addEventListener('click',()=>{
      const d = $('#current-week-date').value;
      if(!d){ alert('현재 주차 시작일을 선택하세요.'); return; }
      currentWeek = ensureWeek(d); saveState(); renderCurrentWeek(); buildPrevWeekOptions();
      const prevSel = $('#prev-week-select');
      if(prevSel.options.length){ prevSel.value = prevSel.options[Math.max(0, prevSel.options.length-2)]?.value || prevSel.options[0].value; }
      loadPrevWeekIntoList($('#prev-week-select').value);
    });

    $('#prev-week-select').addEventListener('change', (e)=>{
      loadPrevWeekIntoList(e.target.value);
    });

    $('#btn-copy-prev').addEventListener('click',()=>{
      const prev = $('#prev-week-select').value;
      if(!prev){ alert('이전 주차가 없습니다.'); return; }
      const wk = state.weeks[prev]; if(!wk){ alert('선택된 이전 주차 데이터가 없습니다.'); return; }
      if(!currentWeek){ alert('먼저 현재 주차를 불러오세요.'); return; }
      if(currentWeek.entries.length>0 && !confirm('현재 목록이 존재합니다. 이전 주차로 덮어쓸까요?')) return;
      currentWeek.entries = wk.entries.map(e=> ({trackId:e.trackId, rank:e.rank, note:''}));
      currentWeek.entries = rankify(currentWeek.entries.sort((a,b)=>a.rank-b.rank));
      saveState(); renderCurrentWeek();
    });

    $('#btn-add-track').addEventListener('click',()=>{
      const id = $('#add-trackid').value.trim(); if(!id) return;
      addTrackToCurrent(id); $('#add-trackid').value='';
    });

    $('#btn-save-week').addEventListener('click',()=>{
      if(!currentWeek){ alert('현재 주차가 없습니다.'); return; }
      currentWeek.entries = rankify(currentWeek.entries);
      state.weeks[currentWeek.weekStart] = currentWeek;
      saveState(); alert('저장되었습니다.'); buildPrevWeekOptions();
    });

    // 처음 렌더 시 이전 주차 드롭다운 채우기
    buildPrevWeekOptions();

    // ============================
    // 백업/복원
    // ============================
    $('#btn-export').addEventListener('click',()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `chart-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    $('#btn-import').addEventListener('click',()=>{
      const file = $('#import-file').files[0];
      if(!file){ alert('가져올 JSON 파일을 선택하세요.'); return; }
      const merge = $('#import-merge').checked;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const data = JSON.parse(fr.result);
          if(!merge && !confirm('기존 데이터를 모두 삭제하고 교체합니다. 진행할까요?')) return;
          if(merge){
            state.songs = { ...(state.songs||{}), ...(data.songs||{}) };
            state.weeks = { ...(state.weeks||{}), ...(data.weeks||{}) };
          } else {
            state = { songs: data.songs||{}, weeks: data.weeks||{} };
          }
          saveState();
          renderSongTable();
          buildPrevWeekOptions();
          renderCurrentWeek();
          alert('가져오기가 완료되었습니다.');
        }catch(e){ alert('가져오기 실패: '+e.message); }
      };
      fr.readAsText(file);
    });

    $('#btn-wipe').addEventListener('click',()=>{
      if(confirm('정말 모든 데이터를 삭제할까요? (되돌릴 수 없음)')){
        state = structuredClone(emptyState); saveState();
        renderSongTable(); buildPrevWeekOptions(); renderCurrentWeek(); alert('초기화되었습니다.');
      }
    });

    // ============================
    // 키보드 단축키
    // ============================
    document.addEventListener('keydown',(e)=>{
      if(e.key==='s' && (e.metaKey||e.ctrlKey)){
        if($('#tab-weeks').hidden) return; e.preventDefault(); $('#btn-save-week').click();
      }
    });
  </script>
</body>
</html>
