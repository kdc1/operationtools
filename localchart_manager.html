<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡œì»¬ ì°¨íŠ¸ ê´€ë¦¬ì</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#2a3545; --text:#e8eef9; --sub:#a8b3c7; --accent:#6aa6ff; --danger:#ff6b6b; --warn:#f9b24d; --ok:#55e6a5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif}
    a{color:var(--accent);text-decoration:none}
    button,input,select,textarea{font:inherit;color:inherit}
    .app{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:16px}
    .title{font-size:20px;font-weight:700}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:var(--panel);border:1px solid var(--muted);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#1a2331,#121821);border-color:#3a4b66}
    .section{background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:16px;margin-bottom:14px}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns: 1fr 1fr}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--sub)}
    .input, .select, .textarea{background:#0e141d;border:1px solid var(--muted);padding:8px 10px;border-radius:10px;outline:none}
    .textarea{min-height:72px;resize:vertical}
    .btn{background:#182233;border:1px solid #334762;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#1b2d4d;border-color:#345a99}
    .btn.ghost{background:transparent;border-color:var(--muted)}
    .btn.warn{background:#3a2a10;border-color:#6a4b1a}
    .btn.danger{background:#3a1414;border-color:#6a2a2a}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--muted);background:#0e141d;font-size:12px;color:var(--sub)}
    .badge.ok{border-color:#256f57;color:#98ffdc}
    .badge.warn{border-color:#7c5a16;color:#ffd79a}
    .badge.danger{border-color:#7c1818;color:#ffb0b0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--muted);padding:8px 6px;text-align:left}
    .table tr:hover{background:#0f1620}
    .helper{font-size:12px;color:var(--sub)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .list{display:flex;flex-direction:column;gap:6px;min-height:200px}
    .item{display:grid;grid-template-columns:40px 1fr auto;gap:10px;align-items:center;background:#0e141d;border:1px solid var(--muted);border-radius:12px;padding:8px}
    .item[data-banned="true"]{opacity:.5}
    .item .drag{cursor:grab;user-select:none;color:var(--sub);text-align:center}
    .item .meta{display:flex;flex-direction:column}
    .item .actions{display:flex;gap:6px}
    .pill{border:1px solid var(--muted);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--sub)}
    .muted{color:var(--sub)}
    .shadow{box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .sticky{position:sticky;top:10px}
    .rank{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#121a26;border:1px solid var(--muted);font-weight:700}
    .hr{height:1px;background:var(--muted);margin:10px 0}
    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,monospace;background:#0e141d;border:1px solid var(--muted);border-bottom-width:3px;padding:2px 6px;border-radius:6px}
    @media (max-width: 980px){
      .grid.cols-2{grid-template-columns: 1fr}
      .split{grid-template-columns: 1fr}
      .sticky{position:static}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="row" style="align-items:center">
        <div class="title">ğŸ›ï¸ ë¡œì»¬ ì°¨íŠ¸ ê´€ë¦¬ì</div>
        <div class="badge">ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê¸°ë°˜</div>
      </div>
      <div class="tabs" role="tablist">
        <button class="tab" data-tab="songs" aria-selected="true">ê³¡ ë°ì´í„°</button>
        <button class="tab" data-tab="weeks">ì£¼ì°¨ ì°¨íŠ¸</button>
        <button class="tab" data-tab="backup">ë°±ì—…/ë³µì›</button>
      </div>
    </div>

    <!-- ê³¡ ë°ì´í„° íƒ­ -->
    <section id="tab-songs" class="section" role="tabpanel">
      <div class="grid cols-2">
        <div class="section shadow">
          <h3 style="margin:0 0 8px">ê³¡ ë“±ë¡/ìˆ˜ì •</h3>
          <div class="grid">
            <div class="field">
              <label>ğŸ íŠ¸ë™ID (í•„ìˆ˜)</label>
              <input id="song-id" class="input" placeholder="ì˜ˆ: 12345678" />
            </div>
            <div class="row">
              <div class="field grow">
                <label>ê³¡ëª…</label>
                <input id="song-title" class="input" />
              </div>
              <div class="field grow">
                <label>ì•„í‹°ìŠ¤íŠ¸ëª…</label>
                <input id="song-artist" class="input" />
              </div>
            </div>
            <div class="row">
              <div class="field grow">
                <label>ë°œë§¤ì¼</label>
                <input id="song-release" type="date" class="input" />
              </div>
              <div class="field grow">
                <label>1ìœ„ ì§€ì •ì¼</label>
                <input id="song-first1" type="date" class="input" />
              </div>
            </div>
            <div class="row">
              <label class="badge warn"><input id="song-blocked" type="checkbox" /> ì°¨ë‹¨ì—¬ë¶€</label>
              <label class="badge danger"><input id="song-banned" type="checkbox" /> ì‚¬ìš©ê¸ˆì§€ì—¬ë¶€</label>
            </div>
            <div class="field">
              <label>ê³¡ íˆìŠ¤í† ë¦¬(ë©”ëª¨)</label>
              <textarea id="song-history" class="textarea" placeholder="ììœ  ì„œìˆ "></textarea>
            </div>
            <div class="row">
              <button id="song-save" class="btn primary">ì €ì¥/ì—…ë°ì´íŠ¸</button>
              <button id="song-clear" class="btn ghost">ì…ë ¥ ì´ˆê¸°í™”</button>
              <span class="helper">í–‰ì„ í´ë¦­í•˜ë©´ í¸ì§‘ë©ë‹ˆë‹¤.</span>
            </div>
          </div>
        </div>
        <div class="section shadow">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">ê³¡ ëª©ë¡</h3>
            <input id="song-search" class="input" placeholder="ê²€ìƒ‰: ì œëª©/ì•„í‹°ìŠ¤íŠ¸/ID" style="max-width:280px" />
          </div>
          <div class="hr"></div>
          <div style="max-height:420px;overflow:auto">
            <table class="table" id="song-table">
              <thead>
                <tr>
                  <th>ID</th><th>ê³¡ëª…</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ë°œë§¤ì¼</th><th>ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ì£¼ì°¨ ì°¨íŠ¸ íƒ­ -->
    <section id="tab-weeks" class="section" role="tabpanel" hidden>
      <div class="grid">
        <div class="section shadow">
          <div class="row" style="align-items:flex-end; gap:12px; flex-wrap:wrap">
            <div class="field">
              <label>í˜„ì¬ ì£¼ì°¨ ì‹œì‘ì¼</label>
              <input type="date" id="current-week-date" class="input" />
            </div>
            <button class="btn" id="btn-load-current">ë¶ˆëŸ¬ì˜¤ê¸°/ìƒì„±</button>
            <div class="field">
              <label>ì´ì „ ì£¼ì°¨ ì„ íƒ</label>
              <select id="prev-week-select" class="select"></select>
            </div>
            <button class="btn ghost" id="btn-copy-prev">ì´ì „ ì£¼ì°¨ ë³µì‚¬ â†’ í˜„ì¬</button>
            <div class="grow"></div>
            <div class="row">
              <input id="add-trackid" class="input" placeholder="íŠ¸ë™ID ì¶”ê°€" style="width:140px" />
              <button class="btn" id="btn-add-track">ì¶”ê°€</button>
              <button class="btn warn" id="btn-save-week">í˜„ì¬ ì£¼ì°¨ ì €ì¥</button>
            </div>
          </div>
        </div>

        <div class="split">
          <div class="section shadow sticky">
            <h3 style="margin:0 0 8px">ì´ì „ ì£¼ì°¨ (ì½ê¸° ì „ìš©)</h3>
            <div id="prev-list" class="list" aria-label="ì´ì „ ì£¼ì°¨ ì°¨íŠ¸"></div>
          </div>
          <div class="section shadow">
            <h3 style="margin:0 0 8px">í˜„ì¬ ì£¼ì°¨ (ë“œë˜ê·¸ë¡œ ìˆœìœ„ í¸ì§‘)</h3>
            <div id="current-list" class="list" aria-label="í˜„ì¬ ì£¼ì°¨ ì°¨íŠ¸"></div>
            <div class="hr"></div>
            <div class="helper">ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë°”ê¾¸ë©´ ìë™ìœ¼ë¡œ ìˆœìœ„ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ê° í•­ëª©ì˜ âœì„ ëˆŒëŸ¬ ì£¼ì°¨ íˆìŠ¤í† ë¦¬ë¥¼ ê¸°ë¡í•˜ì„¸ìš”.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ë°±ì—…/ë³µì› íƒ­ -->
    <section id="tab-backup" class="section" role="tabpanel" hidden>
      <div class="grid">
        <div class="section shadow">
          <h3 style="margin:0 0 8px">JSON ë‚´ë³´ë‚´ê¸°</h3>
          <div class="row">
            <button class="btn primary" id="btn-export">ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
            <span class="helper">í˜„ì¬ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì˜ ëª¨ë“  ë°ì´í„°(songs, weeks)ë¥¼ JSONìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</span>
          </div>
        </div>
        <div class="section shadow">
          <h3 style="margin:0 0 8px">JSON ê°€ì ¸ì˜¤ê¸°</h3>
          <div class="row" style="align-items:center; gap:12px">
            <input type="file" id="import-file" accept="application/json" />
            <label class="badge warn"><input type="checkbox" id="import-merge" checked /> ë³‘í•©(ì¤‘ë³µì€ ë®ì–´ì“°ê¸°)</label>
            <button class="btn danger" id="btn-import">ê°€ì ¸ì˜¤ê¸°</button>
          </div>
          <p class="helper">ë³‘í•©ì„ í•´ì œí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš°ê³  íŒŒì¼ë¡œ êµì²´í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <div class="hr"></div>
          <button class="btn ghost" id="btn-wipe">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </section>
  </div>

  <template id="tmpl-item">
    <div class="item" draggable="true">
      <div class="drag rank">#</div>
      <div class="meta"></div>
      <div class="actions"></div>
    </div>
  </template>

  <script>
    // ============================
    // ì €ì¥ì†Œ (localStorage)
    // ============================
    const STORAGE_KEY = 'chartManagerData.v1';
    const emptyState = { songs: {}, weeks: {} };

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(emptyState);
        const parsed = JSON.parse(raw);
        return { songs: parsed.songs||{}, weeks: parsed.weeks||{} };
      }catch(e){
        console.error('load error',e);return structuredClone(emptyState);
      }
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // ============================
    // ìœ í‹¸
    // ============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function fmtDate(d){
      if(!d) return '';
      try{ return new Date(d).toISOString().slice(0,10);}catch{ return d; }
    }

    function ensureWeek(dateStr){
      if(!state.weeks[dateStr]) state.weeks[dateStr] = { weekStart: dateStr, entries: [] };
      return state.weeks[dateStr];
    }

    function rankify(entries){
      return entries.map((e,i)=> ({...e, rank:i+1}));
    }

    function createSongRow(song){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${song.id}</td>
        <td>${escapeHtml(song.title||'')}</td>
        <td>${escapeHtml(song.artist||'')}</td>
        <td>${fmtDate(song.releaseDate)||''}</td>
        <td>${song.banned?'<span class="pill">ğŸš« ê¸ˆì§€</span>': song.blocked?'<span class="pill">â›” ì°¨ë‹¨</span>':'<span class="pill">ì •ìƒ</span>'}</td>`;
      tr.addEventListener('click',()=>fillSongForm(song));
      return tr;
    }

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    function buildPrevWeekOptions(){
      const sel = $('#prev-week-select');
      sel.innerHTML = '';
      const dates = Object.keys(state.weeks).sort();
      for(const d of dates){
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d; sel.appendChild(opt);
      }
    }

    // ============================
    // íƒ­ ì „í™˜
    // ============================
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.tab').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const tab = btn.dataset.tab;
        $('#tab-songs').hidden = tab!=='songs';
        $('#tab-weeks').hidden = tab!=='weeks';
        $('#tab-backup').hidden = tab!=='backup';
        if(tab==='weeks') buildPrevWeekOptions();
        if(tab==='songs') renderSongTable();
      })
    })

    // ============================
    // ê³¡ CRUD
    // ============================
    function fillSongForm(song){
      $('#song-id').value = song.id || '';
      $('#song-title').value = song.title || '';
      $('#song-artist').value = song.artist || '';
      $('#song-release').value = fmtDate(song.releaseDate) || '';
      $('#song-first1').value = fmtDate(song.firstNo1Date) || '';
      $('#song-blocked').checked = !!song.blocked;
      $('#song-banned').checked = !!song.banned;
      $('#song-history').value = song.history || '';
      $('#song-id').focus();
    }

    function readSongForm(){
      const id = $('#song-id').value.trim();
      if(!id){ alert('íŠ¸ë™IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return null; }
      return {
        id,
        title: $('#song-title').value.trim(),
        artist: $('#song-artist').value.trim(),
        releaseDate: $('#song-release').value || null,
        firstNo1Date: $('#song-first1').value || null,
        blocked: $('#song-blocked').checked,
        banned: $('#song-banned').checked,
        history: $('#song-history').value.trim()
      };
    }

    function clearSongForm(){
      ['song-id','song-title','song-artist','song-release','song-first1','song-history'].forEach(id=>$('#'+id).value='');
      $('#song-blocked').checked=false; $('#song-banned').checked=false;
    }

    function renderSongTable(){
      const q = ($('#song-search').value||'').toLowerCase();
      const tbody = $('#song-table tbody');
      tbody.innerHTML = '';
      const rows = Object.values(state.songs)
        .sort((a,b)=> (a.artist||'').localeCompare(b.artist||'') || (a.title||'').localeCompare(b.title||''))
        .filter(s=> !q || [s.id, s.title, s.artist].join(' ').toLowerCase().includes(q));
      rows.forEach(s=> tbody.appendChild(createSongRow(s)));
    }

    $('#song-save').addEventListener('click',()=>{
      const s = readSongForm(); if(!s) return;
      state.songs[s.id] = s; saveState(); renderSongTable();
      // ì´ë¯¸ ì£¼ì°¨ì— ìˆëŠ” í•­ëª©ì— ìƒíƒœ ë°˜ì˜ì„ ìœ„í•´ í˜„ì¬ ì£¼ì°¨ ì¬ë Œë”
      renderCurrentWeek();
    });
    $('#song-clear').addEventListener('click', clearSongForm);
    $('#song-search').addEventListener('input', renderSongTable);

    renderSongTable();

    // ============================
    // ì£¼ì°¨ ì°¨íŠ¸
    // ============================
    let currentWeek = null; // {weekStart, entries}

    function loadPrevWeekIntoList(dateStr){
      const container = $('#prev-list');
      container.innerHTML = '';
      const wk = state.weeks[dateStr];
      if(!wk){ container.innerHTML = '<div class="muted">ì„ íƒëœ ì´ì „ ì£¼ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      wk.entries.sort((a,b)=>a.rank-b.rank);
      wk.entries.forEach((e,i)=>{
        const song = state.songs[e.trackId] || { id:e.trackId, title:'(ë¯¸ë“±ë¡)', artist:'' };
        const el = renderListItem({ entry:e, song, readonly:true });
        container.appendChild(el);
      });
    }

    function renderListItem({entry, song, readonly}){
      const tpl = document.getElementById('tmpl-item');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.dataset.trackId = entry.trackId;
      node.dataset.banned = song.banned ? 'true' : 'false';
      node.querySelector('.rank').textContent = entry.rank ? '#' + entry.rank : '#';
      node.querySelector('.meta').innerHTML = `
        <div><strong>${escapeHtml(song.title||'(ì œëª©ì—†ìŒ)')}</strong> â€” ${escapeHtml(song.artist||'')}</div>
        <div class="muted">ID: ${song.id} Â· ë°œë§¤ì¼ ${fmtDate(song.releaseDate)||'-'} ${song.blocked?'<span class="badge warn">ì°¨ë‹¨</span>':''} ${song.banned?'<span class="badge danger">ê¸ˆì§€</span>':''}</div>
        ${entry.note?`<div class="helper">ì£¼ì°¨ ë©”ëª¨: ${escapeHtml(entry.note)}</div>`:''}
      `;
      const actions = node.querySelector('.actions');
      if(!readonly){
        const btnNote = document.createElement('button'); btnNote.className='btn ghost'; btnNote.textContent='âœ ë©”ëª¨';
        btnNote.addEventListener('click',()=>{
          const val = prompt('ì´ í•­ëª©ì˜ ì£¼ì°¨ íˆìŠ¤í† ë¦¬/ë©”ëª¨', entry.note||'');
          if(val!==null){ entry.note = val; saveState(); renderCurrentWeek(); }
        });
        const btnRemove = document.createElement('button'); btnRemove.className='btn danger'; btnRemove.textContent='ì‚­ì œ';
        btnRemove.addEventListener('click',()=>{
          currentWeek.entries = currentWeek.entries.filter(x=>x.trackId!==entry.trackId);
          currentWeek.entries = rankify(currentWeek.entries);
          saveState(); renderCurrentWeek();
        });
        actions.append(btnNote, btnRemove);
      } else {
        const pill = document.createElement('span'); pill.className='pill'; pill.textContent = 'ìˆœìœ„ '+entry.rank; actions.appendChild(pill);
      }

      if(!readonly){
        node.addEventListener('dragstart', (ev)=>{
          ev.dataTransfer.setData('text/plain', entry.trackId);
          node.classList.add('dragging');
        });
        node.addEventListener('dragend', ()=> node.classList.remove('dragging'));
      } else {
        node.draggable = false;
      }

      return node;
    }

    function renderCurrentWeek(){
      const container = $('#current-list');
      container.innerHTML = '';
      if(!currentWeek){ container.innerHTML='<div class="muted">ì˜¤ë¥¸ìª½ ìƒë‹¨ì—ì„œ ì£¼ì°¨ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</div>'; return; }
      currentWeek.entries.sort((a,b)=>a.rank-b.rank);
      currentWeek.entries.forEach(e=>{
        const song = state.songs[e.trackId] || { id:e.trackId, title:'(ë¯¸ë“±ë¡)', artist:'' };
        const el = renderListItem({ entry:e, song, readonly:false });
        container.appendChild(el);
      });
      updateDragHandlers();
    }

    function updateDragHandlers(){
      const list = $('#current-list');
      list.addEventListener('dragover', (ev)=>{
        ev.preventDefault();
        const dragging = $('.item.dragging');
        const after = getDragAfterElement(list, ev.clientY);
        if(!dragging) return;
        if(after==null){ list.appendChild(dragging); }
        else { list.insertBefore(dragging, after); }
      });
      list.addEventListener('drop', ()=>{
        // ì½ì–´ ìƒˆ ìˆœìœ„ ë°˜ì˜
        const ids = $$('.item', list).map(n=>n.dataset.trackId);
        currentWeek.entries = ids.map((id,i)=>{
          const found = currentWeek.entries.find(e=>e.trackId===id) || {trackId:id};
          return { ...found, rank: i+1 };
        });
        saveState(); renderCurrentWeek();
      });
    }

    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.item:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){
          return {offset, element: child};
        } else { return closest; }
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    function addTrackToCurrent(trackId){
      if(!currentWeek){ alert('ë¨¼ì € í˜„ì¬ ì£¼ì°¨ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
      if(currentWeek.entries.some(e=>e.trackId===trackId)) return;
      const nextRank = currentWeek.entries.length + 1;
      currentWeek.entries.push({trackId, rank: nextRank, note:''});
      saveState(); renderCurrentWeek();
    }

    // Controls
    $('#btn-load-current').addEventListener('click',()=>{
      const d = $('#current-week-date').value;
      if(!d){ alert('í˜„ì¬ ì£¼ì°¨ ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      currentWeek = ensureWeek(d); saveState(); renderCurrentWeek(); buildPrevWeekOptions();
      const prevSel = $('#prev-week-select');
      if(prevSel.options.length){ prevSel.value = prevSel.options[Math.max(0, prevSel.options.length-2)]?.value || prevSel.options[0].value; }
      loadPrevWeekIntoList($('#prev-week-select').value);
    });

    $('#prev-week-select').addEventListener('change', (e)=>{
      loadPrevWeekIntoList(e.target.value);
    });

    $('#btn-copy-prev').addEventListener('click',()=>{
      const prev = $('#prev-week-select').value;
      if(!prev){ alert('ì´ì „ ì£¼ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const wk = state.weeks[prev]; if(!wk){ alert('ì„ íƒëœ ì´ì „ ì£¼ì°¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(!currentWeek){ alert('ë¨¼ì € í˜„ì¬ ì£¼ì°¨ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
      if(currentWeek.entries.length>0 && !confirm('í˜„ì¬ ëª©ë¡ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ì „ ì£¼ì°¨ë¡œ ë®ì–´ì“¸ê¹Œìš”?')) return;
      currentWeek.entries = wk.entries.map(e=> ({trackId:e.trackId, rank:e.rank, note:''}));
      currentWeek.entries = rankify(currentWeek.entries.sort((a,b)=>a.rank-b.rank));
      saveState(); renderCurrentWeek();
    });

    $('#btn-add-track').addEventListener('click',()=>{
      const id = $('#add-trackid').value.trim(); if(!id) return;
      addTrackToCurrent(id); $('#add-trackid').value='';
    });

    $('#btn-save-week').addEventListener('click',()=>{
      if(!currentWeek){ alert('í˜„ì¬ ì£¼ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      currentWeek.entries = rankify(currentWeek.entries);
      state.weeks[currentWeek.weekStart] = currentWeek;
      saveState(); alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); buildPrevWeekOptions();
    });

    // ì²˜ìŒ ë Œë” ì‹œ ì´ì „ ì£¼ì°¨ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    buildPrevWeekOptions();

    // ============================
    // ë°±ì—…/ë³µì›
    // ============================
    $('#btn-export').addEventListener('click',()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `chart-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    $('#btn-import').addEventListener('click',()=>{
      const file = $('#import-file').files[0];
      if(!file){ alert('ê°€ì ¸ì˜¬ JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      const merge = $('#import-merge').checked;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const data = JSON.parse(fr.result);
          if(!merge && !confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  êµì²´í•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;
          if(merge){
            state.songs = { ...(state.songs||{}), ...(data.songs||{}) };
            state.weeks = { ...(state.weeks||{}), ...(data.weeks||{}) };
          } else {
            state = { songs: data.songs||{}, weeks: data.weeks||{} };
          }
          saveState();
          renderSongTable();
          buildPrevWeekOptions();
          renderCurrentWeek();
          alert('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+e.message); }
      };
      fr.readAsText(file);
    });

    $('#btn-wipe').addEventListener('click',()=>{
      if(confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)')){
        state = structuredClone(emptyState); saveState();
        renderSongTable(); buildPrevWeekOptions(); renderCurrentWeek(); alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ============================
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    // ============================
    document.addEventListener('keydown',(e)=>{
      if(e.key==='s' && (e.metaKey||e.ctrlKey)){
        if($('#tab-weeks').hidden) return; e.preventDefault(); $('#btn-save-week').click();
      }
    });
  </script>
</body>
</html>
